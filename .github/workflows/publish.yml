name: Publish

on:
 push:
  tags:
   - 'v*.*.*'

permissions:
 contents: read
 id-token: write

jobs:
 publish:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout
     uses: actions/checkout@v4

   - name: Setup Node.js 20
     uses: actions/setup-node@v4
     with:
      node-version: 20
      registry-url: https://registry.npmjs.org

   - name: Setup Bun 1.3.5
     uses: oven-sh/setup-bun@v2
     with:
      bun-version: 1.3.5

   - name: Cache Bun package cache
     uses: actions/cache@v4
     with:
      path: ~/.bun/install/cache
      key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
      restore-keys: |
       ${{ runner.os }}-bun-

   - name: Install dependencies
     run: bun install --frozen-lockfile

   - name: Typecheck
     run: bun run typecheck

   - name: Unit tests
     run: bun run test

   - name: Build
     run: bun run build

   - name: Verify tag matches package version
     shell: bash
     run: |
      set -euo pipefail
      TAG_VERSION="${GITHUB_REF_NAME#v}"
      PKG_VERSION="$(node -p "require('./package.json').version")"

      if [[ "$TAG_VERSION" != "$PKG_VERSION" ]]; then
        echo "Tag version ($TAG_VERSION) does not match package.json version ($PKG_VERSION)." >&2
        exit 1
      fi

   - name: Publish to npm
     run: npm publish --provenance --access public
